<?php
// $Id: gv_blocks.module

/**
 * Implements hook_block_info().
 */
function gv_blocks_block_info() {
  $blocks['main_menu_om_news'] = array(
    'info' => t('Main menu om News'), 
    'cache' => DRUPAL_NO_CACHE, // DRUPAL_CACHE_GLOBAL
  );
  $blocks['main_menu_om_providers'] = array(
    'info' => t('Main menu om Providers'),
    'cache' => DRUPAL_NO_CACHE,
  );
  $blocks['main_menu_om_blog'] = array(
    'info' => t('Main menu om Blog'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}


/**
 * Implements hook_block_view().
 */
function gv_blocks_block_view($delta = '') {
  $block = array();
  switch ($delta) {      
    case 'main_menu_om_news':
      $block['subject'] = t('Main menu om News');
      $block['content'] = gv_blocks_get_omMenuBlock_byTitle('News', 'gv_blocks_get_omMenuBlock_News');
      break;
    case 'main_menu_om_providers':
      $block['subject'] = t('Main menu om Providers');
      $block['content'] = gv_blocks_get_omMenuBlock_byTitle('VoIP Providers', 'gv_blocks_get_omMenuBlock_Providers');
      break;
    case 'main_menu_om_blog':
      $block['subject'] = t('Main menu om Blog');
      $block['content'] = gv_blocks_get_omMenuBlock_byTitle('VoIP Blog', 'gv_blocks_get_omMenuBlock_Blog');
      break;
  }
  return $block;
}


/**
 * Dispatcher for getting themed block for MegaMenu by a block title.
 */
function gv_blocks_get_omMenuBlock_byTitle($title, $function) {
// Get main menu wireframe menu
  $submenu = gv_blocks_getSubmenuByTitle('main-menu', $title);
  if (!$submenu) {
    return NULL;
  }
  return $function($submenu);
}


/**
 * Returns a themed News block content for MegaMenu.
 */
function gv_blocks_get_omMenuBlock_News($submenu) {

  return theme('gv_blocks_submenuSimple', array('submenu' => $submenu));
}


/**
 * Returns a themed VoIP Providers block content for MegaMenu.
 */
function gv_blocks_get_omMenuBlock_Providers($submenu) {

  return theme('gv_blocks_submenuSimple', array('submenu' => $submenu));
}


/**
 * Returns a themed VoIP Blog block content for MegaMenu.
 */
function gv_blocks_get_omMenuBlock_Blog($submenu) {

  return theme('gv_blocks_submenuSimple', array('submenu' => $submenu));
}


/**
 * Returns a submenu from a menu.
 */
function gv_blocks_getSubmenuByTitle($menu_name, $submenu_title) {
  $menu = menu_build_tree($menu_name);
  foreach ($menu as $submenu) {
    if ($submenu['link']['link_title'] == $submenu_title) {
      return $submenu;
    }
  }
  return NULL;
}

/**
 * Implements hook_theme().
 */
function gv_blocks_theme($existing, $type, $theme, $path) {
  return array(
     'gv_blocks_submenuSimple' => array(
          'variables' => array('vars' => null),
          //'template' => 'gv_blocks_home',
        ),
  );
}


/**
 * Simple theming of nested submenu.
 */
function theme_gv_blocks_submenuSimple($vars) {
  $level = isset($vars['level']) ? $vars['level'] : 0;
  $out = '<ul>';
  foreach ($vars['submenu']['below'] as $submenu) {
    $out .= '<li>';
    if($level) {
      for ($i = 0; $i < $level; $i++ ) {
        $out .= '--';
      }
    }
    $out .= l(t($submenu['link']['link_title']), $submenu['link']['href']) . '</li>';
    if (isset($submenu['below'])) {
      // Recursion call.
      $out .= theme('gv_blocks_submenuSimple', array('submenu' => $submenu, 'level' => ($level + 1) ));
    }
  }
  $out .= '</ul>';
  return $out;
}